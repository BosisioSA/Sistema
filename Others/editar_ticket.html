<!doctype html>
<html>
    <head>
      <title>Edição Ticket</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      
      <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900" rel="stylesheet">

      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
      <link rel="stylesheet" href="css/style.css">
      <link rel="stylesheet" href="css/table.css">
        <meta name="viewport" content="width=944">
        <meta name="robots" content="noindex, follow">
	<link rel="Shortcut icon" href="/portal.cgi/PP_FILE_STORE/Sistema/assets/img/icons/favicon.ico" type="image/x-icon">
        <link href="/portal.cgi/PP_FILE_STORE/Sistema/assets/img/icons/apple-touch-icon.png" rel="apple-touch-icon" />
        <link href="/portal.cgi/PP_FILE_STORE/Sistema/assets/img/icons/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed" />
        <link href="/portal.cgi/PP_FILE_STORE/Sistema/assets/img/icons/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72" />
        <link href="/portal.cgi/PP_FILE_STORE/Sistema/assets/img/icons/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114" />
        <link href="/portal.cgi/PP_FILE_STORE/Sistema/assets/img/icons/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144" />
        <link rel="stylesheet" href="fonts/fontawesome-all.min.css">
        <link rel="stylesheet" href="fonts/font-awesome.min.css">
        <link rel="stylesheet" href="fonts/fontawesome5-overrides.min.css">
        <script src="js/popper.js"></script>
        <script src="js/jquery.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
          <script src="js/jscolor.js"></script>
    
        <script src="/portal.cgi/PP_FILE_STORE/Sistema/assets/js/vendor/modernizr-2.6.2.min.js"></script>
      	<script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/3rdParty/jquery-1.8.3.min.js'></script>
    	<script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/3rdParty/jquery-ui-1.9.2.custom.js'></script>
    	<script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/3rdParty/jquery.cookie.js'></script>
    	<script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js'></script>
    <!-- portal.js -->
    <!-- portal.js --> <script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/3rdParty/jquery-linedtextarea.js'></script>
    <!-- portal.js --> <script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/3rdParty/codemirror.js'></script>
    <!-- portal.js --> <script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/3rdParty/javascript.js'></script>
    <!-- portal.js --> <script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/3rdParty/jquery.tmpl.js'></script>
    <!-- portal.js --> <script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/3rdParty/jquery-regex.js'></script>
    <!-- portal.js --> <script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/3rdParty/sitemapstyler.js'></script>
    <!-- portal.js --> <script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/3rdParty/date.format.js'></script>
    <!-- portal.js --> <script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/3rdParty/jquery.iframe-transport.js'></script>
    <!-- portal.js --> <script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/3rdParty/jquery.fileupload.js'></script>
    <!-- portal.js --> <script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/3rdParty/jquery.notify.min.js'></script>
    <!-- portal.js --> <script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/3rdParty/jquery.event.drag-2.2.js'></script>
        <script type='text/javascript' src='/portal.cgi?api=js'></script>
    	<script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/portal/js/nixps-portal-api.js'></script>
        <script type='text/javascript' src='/portal.cgi/PP_FILE_STORE/Sistema/3rdParty/jquery.i18n.js'></script>
       
        <script>
            var queryString = window.location.search;
            var ordem = decodeURI(queryString.substring(7,queryString.length))
        </script>
    

    </head>


    <body>

  		<div class="wrapper d-flex align-items-stretch">
  			<nav id="sidebar">
  				<div class="p-4 pt-5">
            <img>
  		  		<img src="./logo/logo_valgroup.png" style="width: 90%; margin-bottom: 50px;">
             
             <div id="div_selecionar_arte"  class="form-group col-md-11" style="display:none;">
                <label style="color: black" for="seleciona_arte">Selecionar Arte</label>
                   <select class="form-control" id="seleciona_arte" onchange="selecionar_arte()" name="seleciona_arte">
                       <option value="undefined">Selecionar...</option>
                    </select>
                 </div>
            <div id="div_img_preview"  class="form-group col-md-11" style="display:none;">
                <a id="link_arquivo" href="" target="_blank"><img id="preview_arquivo" width="90%"></a>
                 </div>
            <div id="div_salva_preview"  class="form-group col-md-11" style="display:none;">
                <button class="btn btn-primary" onclick="salva_preview()">Salvar Preview</button>
                 </div>
                 
            <div   class="form-group col-md-11" style="display:inline-block; margin-top: 100px">
                <a id="info_ospg" class="btn btn-primary">Abrir OSPG</a>
                 </div>
                    
       
   
  	        <div class="footer">
  	        	<p><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0.
  						  Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | This template is made with <i class="icon-heart" aria-hidden="true"></i> by <a href="https://colorlib.com" target="_blank">Colorlib.com</a>
  						   Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. --></p>
  	        </div>
  	      </div>
      	</nav>

          <!-- Page Content  -->
        <div id="content" class="p-4 p-md-5">

          <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">

              <button type="button" id="sidebarCollapse" class="btn btn-primary">
                <i class="fa fa-bars"></i>
                <span class="sr-only">Toggle Menu</span>
              </button>
              <button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                  <i class="fa fa-bars"></i>
              </button>
              <div id="bemvindo" style="margin-left: 20px;"></div>

              <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="nav navbar-nav ml-auto">
                 <li class="nav-item">
                      <a class="nav-link" href="cadastros_clientes.html">Cadastros</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="solicitacao_desenho.html">Tickets</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="alterar_senha.html" target="_Blank">Alterar Senha</a>
                  </li>
                </ul>
              </div>
            </div>
          </nav>
          <div>
        <h2 id="codigo_ticket" style="display:inline-block;">Edição Ticket</h2>
        <br>
         <div  class="form-group col-md-3" style="display:inline-block;">
                <label for="tipo_trabalho">Tipo Trabalho</label>
                   <select class="form-control" id="tipo_trabalho" onchange="muda_tipo_trabalho()" name="tipo_trabalho">
                       <option value="undefined">Selecionar...</option>
                    </select>
                 </div>
         <div  class="form-group col-md-6" style="display:inline-block;">
                <label for="descricao">Descrição</label>
                   <input type="text" class="form-control" id="descricao"  name="descricao">
                 </div>
        <div  class="form-group col-md-2" style="display:inline-block;">
                <label for="data_entrega">Horas</label>
                   <input type="time" class="form-control" id="data_entrega"  name="entrega">
                      
                 </div>
    
        <div  class="form-group col-md-3" style="display:inline-block;">
                <label for="item">Item</label>
                   <input type="text" class="form-control" id="item"  name="item">
                      
                 </div>
               
                 <div  id="div_codigo_arte" class="form-group col-md-2" style="display:inline-block;">
                <label for="codigo_arte">Código Arte</label>
                   <input type="text" class="form-control" id="codigo_arte"  name="codigo_arte">
                      
                 </div>
                 <div id="div_arte_revisao" class="form-group col-md-1" style="display:inline-block;">
                <label for="arte_revisao">REV</label>
                   <input type="number" class="form-control" id="arte_revisao"  name="arte_revisao" step="1" value="0">
                      
                 </div>
                 <div id="div_arte_evolucao" class="form-group col-md-1" style="display:inline-block;">
                <label for="arte_evolucao">EV</label>
                   <input type="number" class="form-control" id="arte_evolucao"  name="arte_evolucao" step="1" value="0">
                      
                 </div>
                  <div  class="form-group col-md-4" style="display:inline-block;">
                <label for="item_referencia">Item Referência</label>
                   <input type="text" class="form-control" id="item_referencia"  name="item_referencia">
                 </div>
                 <br>
                
                 <div  class="form-group col-md-4" style="display:inline-block;">
                <label for="cliente">Cliente</label>
                   <input type="text" class="form-control" id="cliente"  name="cliente" list="os_clientes">
                   <datalist id="os_clientes"></datalist>
                 </div>
                  <div  class="form-group col-md-3" style="display:inline-block;">
                <label for="responsavel_comercial">Responsável Comercial</label>
                   <select class="form-control" id="responsavel_comercial"  name="responsavel_comercial">
                       <option value="undefined">Selecionar...</option>
                    </select>
                 </div>
                 
                  <div  class="form-group col-md-11" style="display:inline-block;">
                <label for="observacoes">Observações</label>
                   <textarea  class="form-control" id="observacoes"  name="observacoes" rows="4">
                       </textarea>
                 </div>
                 
                 
                 
                 
                 <hr>
                 <h6>Checklist Entrada Ticket</h6>
                  <div  class="form-group col-md-3" style="display:inline-block;">
               
                   <input type="checkbox" class="form-group" id="Arte OK"  name="Arte OK">
                    <label for="Arte OK">Arte OK</label>
                      
                 </div>
                 <div  class="form-group col-md-3" style="display:inline-block;">
               
                   <input type="checkbox" class="form-group" id="Referencia de Cor"  name="Referencia de Cor">
                    <label for="Referencia de Cor">Referência de Cor</label>
                      
                 </div>
                 <div  class="form-group col-md-3" style="display:inline-block;">
               
                   <input type="checkbox" class="form-group" id="Especificacao"  name="Especificacao">
                    <label for="Especificacao">Especificação</label>
                      
                 </div>
                 <hr>
                   <h5 id="a_div_observacoes"><i id="observacoesArrow" class="fas fa-chevron-right" onclick="mostraObservacoes()" style="margin-right: 5px; cursor:pointer;"></i>Histórico de Observações</h5>
                 <div id="info_observacoes" class="form-group col-md-11" style="display: none">
                <table id="tabela_observacoes" class="table table-striped table-bordered " cellspacing="0" width="100%" style="display: inline-block">
              <thead style="width: 100%">
            <tr>
                 
             
              <th class="th-sm" style="width:15%">Criada em<!--<br><span  style="margin-left: 5px; display: inline-block; vertical-align: top;"><input id="input_nomelocal" type="text" onkeyup="filtro_localtarja()"></span>-->
              </th>
              <th class="th-sm" style="width:25%">Criada por<!--<br><span  style="margin-left: 5px; display: inline-block; vertical-align: top;"><input id="input_nomelocal" type="text" onkeyup="filtro_localtarja()"></span>-->
              </th>
               <th class="th-sm" style="width:60%">Observação<!--<br><span  style="margin-left: 5px; display: inline-block; vertical-align: top;"><input id="input_nomelocal" type="text" onkeyup="filtro_localtarja()"></span>-->
              </th>
              
           
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
        
       </div>
        <hr>
        <button class="btn btn-primary" onclick="salvar()">Salvar</button>
        <button class="btn btn-primary" onclick="fechar()">Cancelar</button>
            <!-- terminar mostra locais e começa mostra registro -->
            
          
          
           
                <br>
               
              
            </div>
    </div>
        
       
  	
  		
  	
  	<script>
  	    // funcoes de apoio
  	    
  	    var usuario = api.auth.get_current_user()
  	    
  	    document.getElementById("bemvindo").innerText = "Bem vindo, "+usuario.fullname
  	    
      function clearTable(table) {
  var rows = table.rows;
  var i = rows.length;
  while (--i) {
    rows[i].parentNode.removeChild(rows[i]);
    // or
    // table.deleteRow(i);
  }
}

function onlyUnique(value, index, self) {
  return self.indexOf(value) === index;
}

function cmyk2rgb(c, m, y, k, normalized){
    c = (c / 100);
    m = (m / 100);
    y = (y / 100);
    k = (k / 100);
    
    c = c * (1 - k) + k;
    m = m * (1 - k) + k;
    y = y * (1 - k) + k;
    
    var r = 1 - c;
    var g = 1 - m;
    var b = 1 - y;
    
    if(!normalized){
        r = Math.round(255 * r);
        g = Math.round(255 * g);
        b = Math.round(255 * b);
    }
    
    return {
        r: r,
        g: g,
        b: b
    }
}






// preenche Selects

selectTipo = document.getElementById('tipo_trabalho');
    var tiposTipo = api.custom_objects.list_with_options("BR-VALFI_TipoTrabalho",[],["tipo","ascending"]).results
    for (var i = 0; i<tiposTipo.length; i++){
        var opt = document.createElement('option');
        opt.value = tiposTipo[i].tipo;
        opt.innerHTML = tiposTipo[i].tipo;
        selectTipo.appendChild(opt);
    }
    
   
    
    
    // preenche dados se existe ordem

var buscaticket = api.custom_objects.list_with_options("BR-VALFI_Tickets",["_id","equal to",ordem]).results[0]
document.getElementById("codigo_ticket").innerText = "Edição do Ticket "+buscaticket.codigo_ticket
document.getElementById("tipo_trabalho").value = buscaticket.tipo_trabalho
document.getElementById("data_entrega").value = buscaticket.tempo_criacao   
 document.getElementById("codigo_arte").value = buscaticket.info_arte.codigo
 document.getElementById("arte_revisao").value = buscaticket.info_arte.revisao
 document.getElementById("arte_evolucao").value = buscaticket.info_arte.evolucao
 
 document.getElementById("cliente").value = buscaticket.cliente
 document.getElementById("item").value = buscaticket.item
  document.getElementById("item_referencia").value = buscaticket.item_referencia
 document.getElementById("descricao").value = buscaticket.descricao
 
 document.getElementById("Arte OK").checked = buscaticket.checklist_ticket_entrada["Arte OK"]
  document.getElementById("Referencia de Cor").checked = buscaticket.checklist_ticket_entrada["Referencia de Cor"]
   document.getElementById("Especificacao").checked = buscaticket.checklist_ticket_entrada["Especificacao"]
    
document.getElementById("info_ospg").href = "ospg.html?ordem="+buscaticket._id
// mostra selecionar arte se não existe arte asignada

if (buscaticket.arquivo_arte === undefined){
    document.getElementById("div_selecionar_arte").style = "display: inline-block;"
    
    var os_arquivos = api.asset.list_with_options(["cloudflow.enclosing_folder","contains","AMBEV-000001","and","file_extension","equal to",".pdf","or","cloudflow.enclosing_folder","contains","AMBEV-000001","and","file_extension","equal to",".ai"],["document_name","ascending"],["file_name","cloudflow","thumb"]).results
    selectArte = document.getElementById('seleciona_arte');
    for (var i = 0; i<os_arquivos.length; i++){
        var opt = document.createElement('option');
        opt.value = os_arquivos[i]._id;
        opt.innerHTML = os_arquivos[i].file_name;
        selectArte.appendChild(opt);
    }
   
   
    
} else {
    
    document.getElementById("div_img_preview").style = "display: inline-block"
  	            document.getElementById("preview_arquivo").src = "http://35.232.192.44:9090"+buscaticket.arquivo_arte.thumb
  	            document.getElementById("link_arquivo").href = "http://35.232.192.44:9090/portal.cgi?proofscope&url="+encodeURIComponent(buscaticket.arquivo_arte.cloudflow.file)+"&topbar=false"
  	            
    
}

 
    // preenche Datalist
    
     var listaCodigo2 = api.custom_objects.list_with_options("BR-VALFI_clientes",[],["fantasia","ascending"],["fantasia"]).results;
          var options=''; // variable to store the options
          for(var i = 0; i < listaCodigo2.length; i++){
              
          options += '<option value="'+listaCodigo2[i].fantasia+'" />';
  
          }
           document.getElementById('os_clientes').innerHTML = options;
// preenche data de hoje

var hoje = new Date()

  	</script>
  	<script>
  	    function calcula_mudancas(){
  	        
  	        
  	    }
  	</script>
  	
   <script>
       function salva_ticket(){
           var data = {}
           data["_id"] = ordem
           data["unidade"] = document.getElementById("a_unidade").value
           data["tipo_trabalho"] = document.getElementById("tipo_trabalho").value
            data["criado_em"] = buscaticket.criado_em
            data["alterado_em"] = new Date()
            data["alterado_por"] = usuario.fullname
          //  data["ospg"] = document.getElementById("ospg_numero").value
            var info_arte = {}
            info_arte["codigo"] = document.getElementById("codigo_arte").value
            info_arte["revisao"] = document.getElementById("arte_revisao").value
            info_arte["evolucao"] = document.getElementById("arte_evolucao").value
            data["info_arte"] = info_arte
            data["cliente"] = document.getElementById("cliente").value
            data["responsavel_comercial"] = document.getElementById("responsavel_comercial").value
            data["item"] = document.getElementById("item").value
            data["descricao"] = document.getElementById("descricao").value
            data["priorizado"] = false
            data["arte_iniciado"] = false
            data["arte_finalizado"] = false
            var info_checklist = {}
            info_checklist["Arte OK"] = document.getElementById("Arte OK").checked
            info_checklist["Referencia de Cor"] = document.getElementById("Referencia de Cor").checked
            info_checklist["Especificacao"] = document.getElementById("Especificacao").checked
            data["checklist_ticket_entrada"] = info_checklist
            console.log(data)
            api.custom_objects.update("BR-VALFI_Tickets",data)
            document.getElementById("a_unidade").value = "undefined"
             document.getElementById("tipo_trabalho").value = "undefined"
             document.getElementById("codigo_arte").value = ""
             document.getElementById("arte_revisao").value = ""
             document.getElementById("arte_evolucao").value = ""
            document.getElementById("cliente").value = ""
            document.getElementById("item").value = ""
            document.getElementById("descricao").value = ""
            document.getElementById("Arte OK").checked = false
            document.getElementById("Referencia de Cor").checked = false
            document.getElementById("Especificacao").checked = false
            document.getElementById("info_ticket").innerText = "Ticket atualizado com sucesso!"
            
           setTimeout(function(){document.getElementById("info_ticket").innerText = ""; setTimeout(function(){window.close()},1000)}, 3000);
           
       }
       function fecha_ticket(){
           window.close()
       }
       
      
   </script>
   <script>
        function mostraObservacoes(){
         
        var div_cliente = document.getElementById("info_observacoes")
        var icone = document.getElementById("observacoesArrow")
        icone.classList.toggle("fa-chevron-down")
        if (div_cliente.style.display === "none") {
            div_cliente.style.display = "inline-block";
            div_cliente.style.width = "100%";
            } else {
                div_cliente.style.display = "none";
            }
      preenche_observacoes()
      }
       function preenche_observacoes(){
       
        clearTable(document.getElementById("tabela_observacoes"))
          
          
         var table = document.getElementById("tabela_observacoes")
        var qtasrow = table.rows.length
      
            
            for (i=0;i<buscaticket.observacoes.length;i++){
            var row =  table.insertRow(qtasrow);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
           
          
             
            
           
            
            cell1.innerHTML = '<div style="font-size:1em; cursor: pointer">'+dateFormat(new Date(buscaticket.observacoes[i].quando),"dd/mm/yyyy - HH:MM")+'hs</div>'
             cell2.innerHTML = '<div style="font-size:1em; cursor: pointer">'+buscaticket.observacoes[i].quem.fullname+'</div>'
           cell3.innerHTML = '<div style="font-size:1em; cursor: pointer">'+buscaticket.observacoes[i].texto+'</div>'
           
            qtasrow = qtasrow +1
      
      
        
        
    }
  
    }
   </script>
  	<script>
  	    function selecionar_arte(){
  	        console.log(document.getElementById("seleciona_arte").value)
  	        if (document.getElementById("seleciona_arte").value != "undefined"){
  	            var o_asset = api.asset.get(document.getElementById("seleciona_arte").value)
  	            document.getElementById("div_img_preview").style = "display: inline-block"
  	            document.getElementById("preview_arquivo").src = "http://35.232.192.44:9090"+o_asset.thumb
  	            document.getElementById("link_arquivo").href = "http://35.232.192.44:9090/portal.cgi?proofscope&url="+encodeURIComponent(o_asset.cloudflow.file)+"&topbar=false"
  	            document.getElementById("div_salva_preview").style = "display: inline-block"
  	        } else {
  	           document.getElementById("div_img_preview").style = "display: none" 
  	           document.getElementById("preview_arquivo").src = ""
  	            document.getElementById("link_arquivo").href = ""
  	            document.getElementById("div_salva_preview").style = "display: none"
  	        }
  	    }
  	    
  	    function salva_preview(){
  	        var qual_asset = api.asset.get(document.getElementById("seleciona_arte").value)
  	        api.custom_objects.set_keys("BR-VALFI_Tickets",buscaticket._id,{"arquivo_arte":qual_asset})
  	        document.getElementById("div_salva_preview").style = "display: none;"
  	    }
  	</script>
  
  
  	
  






    </body>

</html>